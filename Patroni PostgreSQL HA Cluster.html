
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://govind0229.github.io/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="https://govind0229.github.io/theme/pygments/github.min.css">


  <link rel="stylesheet" type="text/css" href="https://govind0229.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://govind0229.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://govind0229.github.io/theme/font-awesome/css/solid.css">





  


 

<meta name="author" content="Govind kumar" />
<meta name="description" content="High Availability PostgreSQL with Patroni and HAproxy Cluster. Patroni is a tool for setting up PostgreSQL servers in high-availability configuration steps. It is written in Python and available on PyPi." />
<meta name="keywords" content="awesome, thanks">


  <meta property="og:site_name" content="Govind Kumar"/>
  <meta property="og:title" content="Patroni PostgreSQL Cluster With HAProxy"/>
  <meta property="og:description" content="High Availability PostgreSQL with Patroni and HAproxy Cluster. Patroni is a tool for setting up PostgreSQL servers in high-availability configuration steps. It is written in Python and available on PyPi."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://govind0229.github.io/Patroni PostgreSQL HA Cluster.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2022-02-26 00:00:00+05:30"/>
  <meta property="article:modified_time" content="2022-02-26 00:00:00+05:30"/>
  <meta property="article:author" content="https://govind0229.github.io/author/govind-kumar.html">
  <meta property="article:section" content="Linux-Open-Source"/>
  <meta property="article:tag" content="awesome"/>
  <meta property="article:tag" content="thanks"/>
  <meta property="og:image" content="">

  <title>Govind Kumar &ndash; Patroni PostgreSQL Cluster With HAProxy</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="https://govind0229.github.io/">
        <img src="https://govind0229.github.io/theme/img/profile.png" alt="Govind Kumar" title="Govind Kumar">
      </a>

      <h1>
        <a href="https://govind0229.github.io/">Govind Kumar</a>
      </h1>



      <nav>
        <ul class="list">



            <li>
              <a target="_self" href="../drafts/about-me" >About me</a>
            </li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/govind0229" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/govind-kumar-5b497280/" target="_blank">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
          <li>
            <a  class="sc-skype" href="skype:govind0229?chat"Start Chat"" target="_blank">
              <i class="fab fa-skype"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://govind0229.github.io/">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="Patroni PostgreSQL HA Cluster">Patroni PostgreSQL Cluster With HAProxy</h1>
    <p>
      Posted on Sat 26 February 2022 in <a href="https://govind0229.github.io/category/linux-open-source.html">Linux-Open-Source</a>

    </p>
  </header>


  <div>
    <!-- Definitions of interpreted text roles (classes) for S5/HTML data. -->
<!-- This data file has been placed in the public domain. -->
<!-- Colours
======= -->
<!-- Text Sizes
========== -->
<!-- Display in Slides (Presentation Mode) Only
========================================== -->
<!-- Display in Outline Mode Only
============================ -->
<!-- Display in Print Only
===================== -->
<!-- Display in Handout Mode Only
============================ -->
<!-- Incremental Display
=================== -->
<!-- URLS
==== -->
<style> .blueb {color:blue; font-weight:bold; font-size:20px} </style>
<style> .redb {color:red; font-weight:bold; font-size:20px} </style>
<style> .flex {color:#fa7d00; font-weight:bold; font-size:20px} </style>
<style> .leb {color:#059940; font-weight:bold;} </style>
<style> .gb {color:green; font-weight:bold; font-size:20px} </style>
<style> .govind {color:#fa7d00; font-weight:bold;} </style>
<style> .bold {font-weight:bold; font-size: larger;} </style>
<style> .gs {color:#6363ee; font-weight:bold; font-size: x-large;} </style>

<style> .huge {font-size:30px;} </style>
<style> .big {color:black;font-weight:bold;font-size:large;} </style>
<style> .small {font-size:13px;} </style>
<style> .tiny {font-size:10px;} </style>


<style> .blue {color:blue;} </style>
<style> .black {color:black;} </style>
<style> .gray {color:gray;} </style>
<style> .silver {color:silver;} </style>
<style> .white {color:white;} </style>
<style> .maroon {color: maroon;} </style>
<style> .red {color:red;} </style>
<style> .magenta {color:magenta;} </style>
<style> .fuchsia {color:fuchsia;} </style>
<style> .pink {color:pink;} </style>
<style> .orange {color:orange;} </style>
<style> .yellow {color:yellow;} </style>
<style> .lime {color:lime;} </style>
<style> .green {color:green;} </style>
<style> .olive {color:olive;} </style>
<style> .teal {color:teal;} </style>
<style> .cyan {color:cyan;} </style>
<style> .aqua {color:aqua;} </style>
<style> .blue {color:blue;} <style>
<style> .navy {color:navy;} </style>
<style> .purple {color:purple;} </style>

<style> .border {border: 2px solid black;} </style>
<style> .outline {outline-style: dotted;} </style><div class="section" id="patroni-postgresql-cluster">
<h2>Patroni PostgreSQL Cluster</h2>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">High Availability PostgreSQL with Patroni and HAproxy Cluster</p>
</div>
<ul class="simple">
<li>Patroni is a tool for setting up PostgreSQL servers in high-availability configuration steps. It is written in Python and available on PyPi.</li>
<li>The proposed solution addresses the failover problem when one of the nodes fails, but it does not address load balancing when multiple requests to the PostgreSQL database are made.</li>
</ul>
<p><span class="bold">Patroni architecture</span></p>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr><td><img alt="D" src="/img/pgsql-diagram.png" /></td>
</tr>
</tbody>
</table>
<p><span class="bold">Prerequisites</span></p>
<ul class="simple">
<li><tt class="docutils literal">Patroni</tt> - Postgresql operation orchestrator: it supports bootstrapping, automatic failover, streaming replication.</li>
<li><tt class="docutils literal">Etcd</tt> – Manages the cluster: an open-source distributed key-value store providing a hub for cluster coordination and state management. It handles leader elections during network partitions and it can tolerate machine failure.</li>
<li><tt class="docutils literal">HAProxy</tt> – Load Balancer: it offers load balancing and proxying for TCP and HTTP based applications.</li>
</ul>
<p><span class="bold">Installation</span></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><tt class="docutils literal">pg_node1</tt> - 192.168.0.125, <tt class="docutils literal">pg_node2</tt> - 192.168.0.126, <tt class="docutils literal">pg_node3</tt> - 192.168.0.129</p>
<p><tt class="docutils literal">ETCD</tt> - 192.168.0.127</p>
<p class="last"><tt class="docutils literal">HAproxy_node1</tt> - 192.168.0.127</p>
</div>
<p><span class="big">Diagram</span></p>
<img alt="empty" src="/img/new-psclus.png" />
<div class="section" id="install-postgresql">
<h3>Install PostgreSQL</h3>
<p>Enable PostgreSQL13 module on <tt class="docutils literal">pg_node1</tt> or <tt class="docutils literal">pg_node2</tt> or <tt class="docutils literal">pg_node3</tt></p>
<div class="highlight"><pre><span></span>dnf -qy module disable postgresql <span class="c1">#Disable defualt repo</span>

dnf -qy module <span class="nb">enable</span> postgresql:13 <span class="c1">#Enable postgresql 13 repo</span>
</pre></div>
<p>Install PostgreSQL on <tt class="docutils literal">pg_node1</tt> or <tt class="docutils literal">pg_node2</tt> or <tt class="docutils literal">pg_node3</tt></p>
<div class="highlight"><pre><span></span>dnf -y install postgresql postgresql-server postgresql-libs postgresql-odbc postgresql-contrib
</pre></div>
</div>
<div class="section" id="install-patroni">
<h3>Install Patroni</h3>
<p>Patroni is a cluster manager used to customize and automate deployment and maintenance of PostgreSQL HA (High Availability) clusters.</p>
<ul class="simple">
<li>on <tt class="docutils literal">pg_node1</tt> or <tt class="docutils literal">pg_node2</tt> or <tt class="docutils literal">pg_node3</tt></li>
</ul>
<div class="highlight"><pre><span></span>dnf -y install yum-utils
</pre></div>
<p>Install pgdg-redhat-repo-latest</p>
<div class="highlight"><pre><span></span>dnf -y install https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm
</pre></div>
<ul class="simple">
<li>Install <tt class="docutils literal">patroni</tt></li>
</ul>
<div class="highlight"><pre><span></span>dnf -y install patroni
</pre></div>
<p><span class="big">Note:</span> pip3 install -r requirements.txt may not work in later versions of Patroni. Instead, you will need to install the dependencies like this:</p>
<div class="highlight"><pre><span></span>pip3 install patroni<span class="o">[</span>dependencies<span class="o">]</span>
pip3 install patroni<span class="o">[</span>etcd<span class="o">]</span>

<span class="c1">#Or</span>

modprobe softdog <span class="c1">#for watchdog</span>
</pre></div>
<p><span class="gs">Patroni configuration files</span></p>
<ul class="simple">
<li>Patroni is invoked with the path to a configuration file. There is a configuration file for each PostgreSQL node. The configuration file is written in .yml format.</li>
</ul>
<p>configuration <tt class="docutils literal">patroni</tt> for <tt class="docutils literal">pg_node1</tt> or <tt class="docutils literal">pg_node3</tt></p>
<ul class="simple">
<li>Create folder for patroni configuration file.</li>
</ul>
<div class="highlight"><pre><span></span>install -d /etc/patroni/
</pre></div>
<ul>
<li><p class="first">patroni defualt configuration file name is <tt class="docutils literal">/etc/patroni/patroni.yml</tt></p>
<blockquote>
<ul class="simple">
<li>vim /etc/patroni/patroni.yml</li>
</ul>
</blockquote>
</li>
</ul>
<div class="highlight"><pre><span></span>vim /etc/patroni/patroni.yml
</pre></div>
<p>Remove everything from this file, and add the following configuration parameters. Make sure, you change <tt class="docutils literal">namespace</tt>, <tt class="docutils literal">listen</tt> and <tt class="docutils literal">connect_address</tt> to reflect yours.</p>
<div class="highlight"><pre><span></span><span class="n">scope</span><span class="p">:</span> <span class="n">postgres</span>
<span class="n">namespace</span><span class="p">:</span> <span class="o">/</span><span class="n">pg_cluster</span><span class="o">/</span>
<span class="n">name</span><span class="p">:</span> <span class="n">pg_node1</span>

<span class="n">restapi</span><span class="p">:</span>
    <span class="n">listen</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.125</span><span class="p">:</span><span class="mi">8008</span>
    <span class="n">connect_address</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.125</span><span class="p">:</span><span class="mi">8008</span>

<span class="n">etcd</span><span class="p">:</span>
    <span class="n">host</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.125</span><span class="p">:</span><span class="mi">2379</span>

<span class="n">bootstrap</span><span class="p">:</span>
<span class="n">dcs</span><span class="p">:</span>
    <span class="n">ttl</span><span class="p">:</span> <span class="mi">30</span>
    <span class="n">loop_wait</span><span class="p">:</span> <span class="mi">10</span>
    <span class="n">retry_timeout</span><span class="p">:</span> <span class="mi">10</span>
    <span class="n">maximum_lag_on_failover</span><span class="p">:</span> <span class="mi">1048576</span>
    <span class="n">postgresql</span><span class="p">:</span>
    <span class="n">use_pg_rewind</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">use_slots</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">parameters</span><span class="p">:</span>

<span class="n">initdb</span><span class="p">:</span>
<span class="o">-</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">UTF8</span>
<span class="o">-</span> <span class="n">data</span><span class="o">-</span><span class="n">checksums</span>

<span class="n">pg_hba</span><span class="p">:</span>
<span class="o">-</span> <span class="n">host</span>        <span class="nb">all</span>     <span class="nb">all</span>     <span class="nb">all</span>     <span class="n">md5</span>
<span class="o">-</span> <span class="n">host</span> <span class="n">replication</span> <span class="n">replicator</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.125</span><span class="o">/</span><span class="mi">24</span> <span class="n">md5</span>
<span class="o">-</span> <span class="n">host</span> <span class="n">replication</span> <span class="n">replicator</span>  <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.126</span><span class="o">/</span><span class="mi">24</span> <span class="n">md5</span>
<span class="o">-</span> <span class="n">host</span> <span class="n">replication</span> <span class="n">replicator</span>  <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">/</span><span class="mi">32</span> <span class="n">md5</span>
<span class="o">-</span> <span class="n">host</span>    <span class="n">replication</span>     <span class="n">replicator</span>      <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.129</span><span class="o">/</span><span class="mi">24</span>        <span class="n">md5</span>

<span class="n">users</span><span class="p">:</span>
    <span class="n">admin</span><span class="p">:</span>
    <span class="n">password</span><span class="p">:</span> <span class="n">admin</span>
    <span class="n">options</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">createrole</span>
        <span class="o">-</span> <span class="n">createdb</span>

<span class="n">postgresql</span><span class="p">:</span>
<span class="n">listen</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.125</span><span class="p">:</span><span class="mi">5432</span>
<span class="n">connect_address</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.125</span><span class="p">:</span><span class="mi">5432</span>
<span class="n">data_dir</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="n">data</span>
<span class="n">bin_dir</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span>
<span class="n">pgpass</span><span class="p">:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pgpass</span>
<span class="n">authentication</span><span class="p">:</span>
    <span class="n">replication</span><span class="p">:</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">replicator</span>
    <span class="n">password</span><span class="p">:</span> <span class="n">replicator</span>
    <span class="n">superuser</span><span class="p">:</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">postgres</span>
    <span class="n">password</span><span class="p">:</span> <span class="n">postgres</span>

<span class="n">tags</span><span class="p">:</span>
    <span class="n">nofailover</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">noloadbalance</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">clonefrom</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">nosync</span><span class="p">:</span> <span class="n">false</span>

<span class="n">watchdog</span><span class="p">:</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">automatic</span>
    <span class="n">device</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">watchdog</span>
    <span class="n">safety_margin</span><span class="p">:</span> <span class="mi">5</span>
</pre></div>
<p>configuration <tt class="docutils literal">patroni</tt> for <tt class="docutils literal">pg_node2</tt></p>
<ul class="simple">
<li>Create folder for patroni configuration file.</li>
</ul>
<div class="highlight"><pre><span></span>install -d /etc/patroni/
</pre></div>
<ul>
<li><p class="first">patroni defualt configuration file name is <tt class="docutils literal">/etc/patroni/patroni.yml</tt></p>
<blockquote>
<ul class="simple">
<li>vim /etc/patroni/patroni.yml</li>
</ul>
</blockquote>
</li>
</ul>
<div class="highlight"><pre><span></span>vim /etc/patroni/patroni.yml
</pre></div>
<p>Remove everything from this file, and add the following configuration parameters. Make sure, you change <tt class="docutils literal">namespace</tt>, <tt class="docutils literal">listen</tt> and <tt class="docutils literal">connect_address</tt> to reflect yours.</p>
<div class="highlight"><pre><span></span><span class="n">scope</span><span class="p">:</span> <span class="n">postgres</span>
<span class="n">namespace</span><span class="p">:</span> <span class="o">/</span><span class="n">pg_cluster</span><span class="o">/</span>
<span class="n">name</span><span class="p">:</span> <span class="n">pg_node2</span>

<span class="n">restapi</span><span class="p">:</span>
    <span class="n">listen</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.126</span><span class="p">:</span><span class="mi">8008</span>
    <span class="n">connect_address</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.126</span><span class="p">:</span><span class="mi">8008</span>

<span class="n">etcd</span><span class="p">:</span>
    <span class="n">host</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.127</span><span class="p">:</span><span class="mi">2379</span>

<span class="n">bootstrap</span><span class="p">:</span>
<span class="n">dcs</span><span class="p">:</span>
    <span class="n">ttl</span><span class="p">:</span> <span class="mi">30</span>
    <span class="n">loop_wait</span><span class="p">:</span> <span class="mi">3</span>
    <span class="n">retry_timeout</span><span class="p">:</span> <span class="mi">3</span>
    <span class="n">maximum_lag_on_failover</span><span class="p">:</span> <span class="mi">1048576</span>
    <span class="n">postgresql</span><span class="p">:</span>
    <span class="n">use_pg_rewind</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">use_slots</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">parameters</span><span class="p">:</span>
        <span class="n">wal_level</span><span class="p">:</span> <span class="n">replica</span>
        <span class="n">hot_standby</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span>
        <span class="n">wal_keep_segments</span><span class="p">:</span> <span class="mi">400</span>
        <span class="n">max_wal_senders</span><span class="p">:</span> <span class="mi">5</span>
        <span class="n">max_replication_slots</span><span class="p">:</span> <span class="mi">5</span>
        <span class="n">checkpoint_timeout</span><span class="p">:</span> <span class="mi">30</span>

<span class="n">initdb</span><span class="p">:</span>
<span class="o">-</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">UTF8</span>
<span class="o">-</span> <span class="n">data</span><span class="o">-</span><span class="n">checksums</span>

<span class="n">pg_hba</span><span class="p">:</span>
<span class="o">-</span> <span class="n">host</span>        <span class="nb">all</span>     <span class="nb">all</span>     <span class="nb">all</span>     <span class="n">md5</span>
<span class="o">-</span> <span class="n">host</span> <span class="n">replication</span> <span class="n">replicator</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.125</span><span class="o">/</span><span class="mi">24</span> <span class="n">md5</span>
<span class="o">-</span> <span class="n">host</span> <span class="n">replication</span> <span class="n">replicator</span>  <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.126</span><span class="o">/</span><span class="mi">24</span> <span class="n">md5</span>
<span class="o">-</span> <span class="n">host</span> <span class="n">replication</span> <span class="n">replicator</span>  <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.129</span><span class="o">/</span><span class="mi">24</span> <span class="n">md5</span>
<span class="o">-</span> <span class="n">host</span> <span class="n">replication</span> <span class="n">replicator</span>  <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">/</span><span class="mi">32</span> <span class="n">md5</span>
<span class="o">-</span> <span class="n">host</span> <span class="n">replication</span> <span class="n">replicator</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">32</span> <span class="n">md5</span>

<span class="n">users</span><span class="p">:</span>
    <span class="n">admin</span><span class="p">:</span>
    <span class="n">password</span><span class="p">:</span> <span class="n">admin</span>
    <span class="n">options</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">createrole</span>
        <span class="o">-</span> <span class="n">createdb</span>

<span class="n">postgresql</span><span class="p">:</span>
<span class="n">listen</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.126</span><span class="p">:</span><span class="mi">5432</span>
<span class="n">connect_address</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.126</span><span class="p">:</span><span class="mi">5432</span>
<span class="n">data_dir</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="n">data</span>
<span class="n">bin_dir</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span>
<span class="n">pgpass</span><span class="p">:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pgpass</span>
<span class="n">authentication</span><span class="p">:</span>
    <span class="n">replication</span><span class="p">:</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">replicator</span>
    <span class="n">password</span><span class="p">:</span> <span class="n">replicator</span>
    <span class="n">superuser</span><span class="p">:</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">postgres</span>
    <span class="n">password</span><span class="p">:</span> <span class="n">postgres</span>

<span class="n">tags</span><span class="p">:</span>
    <span class="n">nofailover</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">noloadbalance</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">clonefrom</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">nosync</span><span class="p">:</span> <span class="n">false</span>

<span class="n">watchdog</span><span class="p">:</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">automatic</span>
    <span class="n">device</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">watchdog</span>
    <span class="n">safety_margin</span><span class="p">:</span> <span class="mi">5</span>
</pre></div>
<p>Save and close the editor when you are finished.</p>
</div>
<div class="section" id="install-etcd">
<h3>Install etcd</h3>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">etcd is a strongly consistent, distributed key-value store that provides a reliable way to store data that needs to be accessed by a distributed system or cluster of machines. We will use etcd to store the state of the Postgres cluster in order to keep the Postgres cluster up and running.</p>
</div>
<p><span class="big">note</span> Make sure to download the latest version of etcd.</p>
<blockquote>
<div class="highlight"><pre><span></span>curl -L https://github.com/coreos/etcd/releases/download/v3.3.2/etcd-v3.3.2-linux-amd64.tar.gz -/tmp/etcd-v3.3.2-linux-amd64.tar.gz
</pre></div>
<p>Unpack the archive:</p>
<div class="highlight"><pre><span></span>tar xvf etcd-v3.3.2-linux-amd64
</pre></div>
<p>Start Etcd:</p>
<div class="highlight"><pre><span></span>./etcd<span class="p">&amp;</span>
</pre></div>
</blockquote>
<p><span class="incremental">OR</span> you can install <tt class="docutils literal">etcd</tt> as a service that you will need to start.</p>
<p><span class="gs">Configuration ETCD</span></p>
<div class="highlight"><pre><span></span>vim /etc/etcd/etcd.conf
</pre></div>
<ul class="simple">
<li>Added menmber configuration for <tt class="docutils literal">Haproxy_node1</tt></li>
</ul>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Member</span><span class="p">]</span>
<span class="c1">#ETCD_CORS=&quot;&quot;</span>
<span class="n">ETCD_NAME</span><span class="o">=</span><span class="s2">&quot;pg_node1&quot;</span>
<span class="n">ETCD_DATA_DIR</span><span class="o">=</span><span class="s2">&quot;/var/lib/etcd/default.etcd&quot;</span>
<span class="c1">#ETCD_WAL_DIR=&quot;&quot;</span>
<span class="n">ETCD_LISTEN_PEER_URLS</span><span class="o">=</span><span class="s2">&quot;http://192.168.0.125:2380,http://localhost:2380&quot;</span>
<span class="n">ETCD_LISTEN_CLIENT_URLS</span><span class="o">=</span><span class="s2">&quot;http://192.168.0.127:2379,http://localhost:2379&quot;</span>
<span class="n">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="o">=</span><span class="s2">&quot;http://192.168.0.125:2380&quot;</span>
<span class="n">ETCD_ADVERTISE_CLIENT_URLS</span><span class="o">=</span><span class="s2">&quot;http://192.168.0.127:2379&quot;</span>
<span class="n">ETCD_INITIAL_CLUSTER</span><span class="o">=</span><span class="s2">&quot;pg_node1=http://192.168.0.125:2380,pg_node2=http://192.168.0.126:2380&quot;</span>
<span class="n">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="o">=</span><span class="s2">&quot;pg_node&quot;</span>
<span class="n">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span><span class="s2">&quot;new&quot;</span>
</pre></div>
<p><span class="bold">start etcd service</span></p>
<blockquote>
<ul>
<li><p class="first">etcd.service</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="s2">&quot;ETCD Service&quot;</span>
<span class="n">Documentation</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">etcd</span><span class="o">-</span><span class="n">io</span><span class="o">/</span><span class="n">etcd</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Type</span><span class="o">=</span><span class="n">notify</span>
<span class="n">User</span><span class="o">=</span><span class="n">etcd</span>
<span class="n">Group</span><span class="o">=</span><span class="n">etcd</span>
<span class="n">ProtectSystem</span><span class="o">=</span><span class="n">full</span>
<span class="n">ProtectHome</span><span class="o">=</span><span class="n">read</span><span class="o">-</span><span class="n">only</span>
<span class="n">PrivateTmp</span><span class="o">=</span><span class="n">yes</span>
<span class="n">PrivateDevices</span><span class="o">=</span><span class="n">yes</span>
<span class="n">SecureBits</span><span class="o">=</span><span class="n">keep</span><span class="o">-</span><span class="n">caps</span>
<span class="n">AmbientCapabilities</span><span class="o">=</span><span class="n">CAP_IPC_LOCK</span>
<span class="n">NoNewPrivileges</span><span class="o">=</span><span class="n">yes</span>
<span class="n">EnvironmentFile</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">etcd</span><span class="o">.</span><span class="n">conf</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">etcd</span>
<span class="n">Restart</span><span class="o">=</span><span class="n">always</span>
<span class="n">RestartSec</span><span class="o">=</span><span class="mi">10</span><span class="n">s</span>
<span class="n">LimitNOFILE</span><span class="o">=</span><span class="mi">40000</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</li>
</ul>
</blockquote>
<div class="highlight"><pre><span></span>systemctl <span class="nb">enable</span> --now etct.service
</pre></div>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr><td><img alt="E" src="/img/etcd-status.png" /></td>
</tr>
</tbody>
</table>
<p>Login <span class="gs">pg_node1</span></p>
<ul class="simple">
<li>start <tt class="docutils literal">patroni</tt> service</li>
</ul>
<div class="highlight"><pre><span></span>systemctl <span class="nb">enable</span> --now patroni.serice
</pre></div>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr><td><img alt="C" src="/img/patroni-pgnode1.png" /></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal">ETCD</tt> add pg_node2 and pg_node3 member with below command</p>
</div>
<div class="highlight"><pre><span></span>etcdctl member remove pg_node2 http://192.168.0.126:2380
etcdctl member remove pg_node3 http://192.168.0.129:2380
</pre></div>
<ul>
<li><p class="first">Check etcd members</p>
<div class="highlight"><pre><span></span>etcdctl member list
</pre></div>
</li>
</ul>
<p>Login <span class="gs">pg_node2</span></p>
<ul class="simple">
<li>start <tt class="docutils literal">patroni</tt> service</li>
</ul>
<div class="highlight"><pre><span></span>systemctl <span class="nb">enable</span> --now patroni.serice
</pre></div>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr><td><img alt="B" src="/img/replication.png" /></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">same configure on pg_node3.</p>
</div>
</div>
<div class="section" id="install-haproxy">
<h3>Install HAProxy</h3>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">HAProxy is free, open source software that provides a high availability load balancer and proxy server for TCP and HTTP-based applications that spreads requests across multiple servers. HAProxy forwards the connection to whichever node is currently the master. It does this using a REST endpoint that Patroni provides. Patroni ensures that, at any given time, only the master node will appear as online, forcing HAProxy to connect to the correct node.</p>
</div>
<ul>
<li><p class="first">login HAproxy_node1 and install HAproxy</p>
<blockquote>
<div class="highlight"><pre><span></span>dnf install haproxy -y
</pre></div>
</blockquote>
</li>
</ul>
<p><span class="gs">Configure HAProxy</span></p>
<ul class="simple">
<li>Login on both node and configure</li>
</ul>
<p>backup default haproxy.conf file</p>
<blockquote>
<div class="highlight"><pre><span></span>cp -f /etc/haproxy/haproxy.cfg cp -f /etc/haproxy/haproxy.cfg-orig
</pre></div>
</blockquote>
<p>Remove everything from this file, and add the following configuration parameters.</p>
<blockquote>
<div class="highlight"><pre><span></span><span class="c1">#---------------------------------------------------------------------</span>
<span class="c1"># Example configuration for a possible web application.  See the</span>
<span class="c1"># full configuration options online.</span>
<span class="c1">#</span>
<span class="c1">#   https://www.haproxy.org/download/1.8/doc/configuration.txt</span>
<span class="c1">#</span>
<span class="c1">#---------------------------------------------------------------------</span>

<span class="c1">#---------------------------------------------------------------------</span>
<span class="c1"># Global settings</span>
<span class="c1">#---------------------------------------------------------------------</span>

<span class="k">global</span>
    <span class="n">log</span>                 <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">local0</span>
    <span class="n">ssl</span><span class="o">-</span><span class="n">default</span><span class="o">-</span><span class="n">bind</span><span class="o">-</span><span class="n">options</span> <span class="n">no</span><span class="o">-</span><span class="n">sslv3</span>
    <span class="n">tune</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">default</span><span class="o">-</span><span class="n">dh</span><span class="o">-</span><span class="n">param</span> <span class="mi">2048</span>
    <span class="n">chroot</span>              <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">haproxy</span>
    <span class="n">pidfile</span>             <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">pid</span>
    <span class="n">maxconn</span>             <span class="mi">4000</span>
    <span class="n">user</span>                <span class="n">haproxy</span>
    <span class="n">group</span>               <span class="n">haproxy</span>
    <span class="n">daemon</span>
    <span class="n">stats</span> <span class="n">socket</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">stats</span>

<span class="n">defaults</span>
    <span class="n">mode</span>                        <span class="n">tcp</span>
    <span class="n">log</span>                         <span class="k">global</span>
    <span class="n">option</span>                      <span class="n">tcplog</span>
    <span class="n">option</span>                      <span class="n">dontlognull</span>
    <span class="n">option</span>                      <span class="n">http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">close</span>
    <span class="c1">#option     forwardfor       except 127.0.0.0/8</span>
    <span class="n">option</span>                      <span class="n">redispatch</span>
    <span class="n">retries</span>                     <span class="mi">3</span>
    <span class="n">timeout</span> <span class="n">http</span><span class="o">-</span><span class="n">request</span>        <span class="mi">10</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">queue</span>               <span class="mi">1</span><span class="n">m</span>
    <span class="n">timeout</span> <span class="n">connect</span>             <span class="mi">10</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">client</span>              <span class="mi">1</span><span class="n">m</span>
    <span class="n">timeout</span> <span class="n">server</span>              <span class="mi">1</span><span class="n">m</span>
    <span class="n">timeout</span> <span class="n">http</span><span class="o">-</span><span class="n">keep</span><span class="o">-</span><span class="n">alive</span>     <span class="mi">10</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">check</span>               <span class="mi">10</span><span class="n">s</span>


<span class="c1">#---------------------------------------------------------------------</span>
<span class="c1"># main frontend which proxys to the backends</span>
<span class="c1">#---------------------------------------------------------------------</span>

<span class="n">listen</span> <span class="n">stats</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">8089</span>
    <span class="n">stats</span> <span class="n">enable</span>
    <span class="n">stats</span> <span class="n">uri</span> <span class="o">/</span>

<span class="n">listen</span> <span class="n">primary</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">5432</span>

    <span class="n">timeout</span> <span class="n">client</span>  <span class="mi">10800</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">server</span>  <span class="mi">10800</span><span class="n">s</span>

    <span class="n">balance</span> <span class="n">leastconn</span>
    <span class="n">option</span> <span class="n">httpchk</span> <span class="n">OPTIONS</span> <span class="o">/</span><span class="n">master</span>
    <span class="n">option</span> <span class="n">allbackups</span>
    <span class="n">balance</span> <span class="n">leastconn</span>
    <span class="n">http</span><span class="o">-</span><span class="n">check</span> <span class="n">expect</span> <span class="n">status</span> <span class="mi">200</span>
    <span class="n">default</span><span class="o">-</span><span class="n">server</span> <span class="n">inter</span> <span class="mi">3</span><span class="n">s</span> <span class="n">fall</span> <span class="mi">3</span> <span class="n">rise</span> <span class="mi">3</span> <span class="n">on</span><span class="o">-</span><span class="n">marked</span><span class="o">-</span><span class="n">down</span> <span class="n">shutdown</span><span class="o">-</span><span class="n">sessions</span>

    <span class="n">server</span> <span class="n">pg_node1</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.125</span><span class="p">:</span><span class="mi">5432</span> <span class="n">maxconn</span> <span class="mi">1000</span> <span class="n">check</span> <span class="n">port</span> <span class="mi">8008</span> <span class="c1">#check-ssl verify none</span>
    <span class="n">server</span> <span class="n">pg_node2</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.126</span><span class="p">:</span><span class="mi">5432</span> <span class="n">maxconn</span> <span class="mi">1000</span> <span class="n">check</span> <span class="n">port</span> <span class="mi">8008</span>
    <span class="n">server</span> <span class="n">pg_node2</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.129</span><span class="p">:</span><span class="mi">5432</span> <span class="n">maxconn</span> <span class="mi">1000</span> <span class="n">check</span> <span class="n">port</span> <span class="mi">8008</span>



<span class="n">listen</span> <span class="n">standbys</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">5433</span>

    <span class="n">timeout</span> <span class="n">client</span>  <span class="mi">10800</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">server</span>  <span class="mi">10800</span><span class="n">s</span>

    <span class="n">balance</span> <span class="n">leastconn</span>
    <span class="n">option</span> <span class="n">httpchk</span> <span class="n">OPTIONS</span> <span class="o">/</span><span class="n">replica</span>
    <span class="n">option</span> <span class="n">allbackups</span>
    <span class="n">balance</span> <span class="n">leastconn</span>
    <span class="n">http</span><span class="o">-</span><span class="n">check</span> <span class="n">expect</span> <span class="n">status</span> <span class="mi">200</span>
    <span class="n">default</span><span class="o">-</span><span class="n">server</span> <span class="n">inter</span> <span class="mi">3</span><span class="n">s</span> <span class="n">fall</span> <span class="mi">3</span> <span class="n">rise</span> <span class="mi">3</span> <span class="n">on</span><span class="o">-</span><span class="n">marked</span><span class="o">-</span><span class="n">down</span> <span class="n">shutdown</span><span class="o">-</span><span class="n">sessions</span>

    <span class="n">server</span> <span class="n">pg_node1</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.125</span><span class="p">:</span><span class="mi">5432</span> <span class="n">maxconn</span> <span class="mi">1000</span> <span class="n">check</span> <span class="n">port</span> <span class="mi">8008</span>
    <span class="n">server</span> <span class="n">pg_node2</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.126</span><span class="p">:</span><span class="mi">5432</span> <span class="n">maxconn</span> <span class="mi">1000</span> <span class="n">check</span> <span class="n">port</span> <span class="mi">8008</span>
    <span class="n">server</span> <span class="n">pg_node2</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.129</span><span class="p">:</span><span class="mi">5432</span> <span class="n">maxconn</span> <span class="mi">1000</span> <span class="n">check</span> <span class="n">port</span> <span class="mi">8008</span>
</pre></div>
</blockquote>
<p>Check configuration file with below command;</p>
<blockquote>
<div class="highlight"><pre><span></span>haproxy -c -V -f /etc/haproxy/haproxy.cfg
</pre></div>
</blockquote>
<p>If any error correct then start haproxy service.</p>
<blockquote>
<div class="highlight"><pre><span></span>setsebool -P haproxy_connect_any on

systemctl <span class="nb">enable</span> --now haproxy.service
</pre></div>
</blockquote>
<p><span class="big">HAproxy Statistics Report;</span></p>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr><td><img alt="G" src="/img/hastatus.png" /></td>
</tr>
</tbody>
</table>
<p><span class="big">If pg_node2 stop haproxy cluster automatically up pg_node1;</span></p>
<p><span class="gs">example</span></p>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr><td><img alt="M" src="/img/ha127.png" /></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>pg_node1 is going down!</li>
</ul>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr><td><img alt="L" src="/img/ha127-1.png" /></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>pg_node3 is going up!</li>
</ul>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr><td><img alt="N" src="/img/ha127-2.png" /></td>
</tr>
</tbody>
</table>
</div>
</div>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://govind0229.github.io/tag/awesome.html">awesome</a>
      <a href="https://govind0229.github.io/tag/thanks.html">thanks</a>
    </p>
  </div>





</article>

    <footer>
<p>&copy; 2022 Govind Kumar</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Govind Kumar ",
  "url" : "https://govind0229.github.io",
  "image": "",
  "description": ""
}
</script>

</body>
</html>