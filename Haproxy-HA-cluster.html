
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://govind0229.github.io/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="https://govind0229.github.io/theme/pygments/github.min.css">


  <link rel="stylesheet" type="text/css" href="https://govind0229.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://govind0229.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://govind0229.github.io/theme/font-awesome/css/solid.css">





  


 

<meta name="author" content="Govind kumar" />
<meta name="description" content="Haproxy cluster with Keepalived Installation Guide!, HAProxy is a free, open source HA load balancer and proxy server for TCP and HTTP-based applications that distributes requests across many servers with high availability. The connection is forwarded by HAProxy to whatever node is the master at the time." />
<meta name="keywords" content="awesome, thanks">


  <meta property="og:site_name" content="Govind Kumar"/>
  <meta property="og:title" content="Haproxy HA Cluster"/>
  <meta property="og:description" content="Haproxy cluster with Keepalived Installation Guide!, HAProxy is a free, open source HA load balancer and proxy server for TCP and HTTP-based applications that distributes requests across many servers with high availability. The connection is forwarded by HAProxy to whatever node is the master at the time."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://govind0229.github.io/Haproxy-HA-cluster.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2022-02-24 15:20:00+05:30"/>
  <meta property="article:modified_time" content="2022-02-25 10:19:00+05:30"/>
  <meta property="article:author" content="https://govind0229.github.io/author/govind-kumar.html">
  <meta property="article:section" content="Linux-Open-Source"/>
  <meta property="article:tag" content="awesome"/>
  <meta property="article:tag" content="thanks"/>
  <meta property="og:image" content="">

  <title>Govind Kumar &ndash; Haproxy HA Cluster</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="https://govind0229.github.io/">
        <img src="https://govind0229.github.io/theme/img/profile.png" alt="Govind Kumar" title="Govind Kumar">
      </a>

      <h1>
        <a href="https://govind0229.github.io/">Govind Kumar</a>
      </h1>



      <nav>
        <ul class="list">



            <li>
              <a target="_self" href="../drafts/about-me" >About me</a>
            </li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/govind0229" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/govind-kumar-5b497280/" target="_blank">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
          <li>
            <a  class="sc-skype" href="skype:govind0229?chat"Start Chat"" target="_blank">
              <i class="fab fa-skype"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://govind0229.github.io/">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="Haproxy-HA-cluster">Haproxy HA Cluster</h1>
    <p>
      Posted on Thu 24 February 2022 in <a href="https://govind0229.github.io/category/linux-open-source.html">Linux-Open-Source</a>

    </p>
  </header>


  <div>
    <!-- Definitions of interpreted text roles (classes) for S5/HTML data. -->
<!-- This data file has been placed in the public domain. -->
<!-- Colours
======= -->
<!-- Text Sizes
========== -->
<!-- Display in Slides (Presentation Mode) Only
========================================== -->
<!-- Display in Outline Mode Only
============================ -->
<!-- Display in Print Only
===================== -->
<!-- Display in Handout Mode Only
============================ -->
<!-- Incremental Display
=================== -->
<!-- URLS
==== -->
<style> .blueb {color:blue; font-weight:bold; font-size:20px} </style>
<style> .redb {color:red; font-weight:bold; font-size:20px} </style>
<style> .flex {color:#fa7d00; font-weight:bold; font-size:20px} </style>
<style> .leb {color:#059940; font-weight:bold;} </style>
<style> .gb {color:green; font-weight:bold; font-size:20px} </style>
<style> .govind {color:#fa7d00; font-weight:bold;} </style>
<style> .bold {font-weight:bold; font-size: larger;} </style>
<style> .gs {color:#6363ee; font-weight:bold; font-size: x-large;} </style>

<style> .huge {font-size:30px;} </style>
<style> .big {color:black;font-weight:bold;font-size:large;} </style>
<style> .small {font-size:13px;} </style>
<style> .tiny {font-size:10px;} </style>


<style> .blue {color:blue;} </style>
<style> .black {color:black;} </style>
<style> .gray {color:gray;} </style>
<style> .silver {color:silver;} </style>
<style> .white {color:white;} </style>
<style> .maroon {color: maroon;} </style>
<style> .red {color:red;} </style>
<style> .magenta {color:magenta;} </style>
<style> .fuchsia {color:fuchsia;} </style>
<style> .pink {color:pink;} </style>
<style> .orange {color:orange;} </style>
<style> .yellow {color:yellow;} </style>
<style> .lime {color:lime;} </style>
<style> .green {color:green;} </style>
<style> .olive {color:olive;} </style>
<style> .teal {color:teal;} </style>
<style> .cyan {color:cyan;} </style>
<style> .aqua {color:aqua;} </style>
<style> .blue {color:blue;} <style>
<style> .navy {color:navy;} </style>
<style> .purple {color:purple;} </style>

<style> .border {border: 2px solid black;} </style>
<style> .outline {outline-style: dotted;} </style><div class="section" id="haproxy-cluster">
<h2>HAProxy Cluster</h2>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">HAProxy is a free, open source HA load balancer and proxy server for TCP and HTTP-based applications that distributes requests across many servers with high availability. The connection is forwarded by HAProxy to whatever node is the master at the time. Patroni's REST endpoint is used to do this. Patroni makes sure that only the master node is online at any given time, forcing HAProxy to connect to the proper node.</p>
</div>
<ul class="simple">
<li>login HAproxy_node1 or HAproxy_node2 and install HAproxy &amp; Keepalived</li>
</ul>
<div class="highlight"><pre><span></span>dnf install haproxy keepalived -y
</pre></div>
<p><span class="gs">Configure HAProxy</span></p>
<ul class="simple">
<li>Login on both node and configure</li>
</ul>
<p>backup default haproxy.conf file</p>
<pre class="code sh literal-block">
cp -f /etc/haproxy/haproxy.cfg cp -f /etc/haproxy/haproxy.cfg-orig
</pre>
<p>Remove everything from this file, and add the following configuration parameters.</p>
<div class="highlight"><pre><span></span><span class="c1">#---------------------------------------------------------------------</span>
<span class="c1"># Example configuration for a possible web application.  See the</span>
<span class="c1"># full configuration options online.</span>
<span class="c1">#</span>
<span class="c1">#   https://www.haproxy.org/download/1.8/doc/configuration.txt</span>
<span class="c1">#</span>
<span class="c1">#---------------------------------------------------------------------</span>

<span class="c1">#---------------------------------------------------------------------</span>
<span class="c1"># Global settings</span>
<span class="c1">#---------------------------------------------------------------------</span>

<span class="k">global</span>
<span class="n">log</span>     <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">local0</span>
<span class="n">ssl</span><span class="o">-</span><span class="n">default</span><span class="o">-</span><span class="n">bind</span><span class="o">-</span><span class="n">options</span> <span class="n">no</span><span class="o">-</span><span class="n">sslv3</span>
<span class="n">tune</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">default</span><span class="o">-</span><span class="n">dh</span><span class="o">-</span><span class="n">param</span> <span class="mi">2048</span>
<span class="n">chroot</span>      <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">haproxy</span>
<span class="n">pidfile</span>     <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">pid</span>
<span class="n">maxconn</span>     <span class="mi">4000</span>
<span class="n">user</span>    <span class="n">haproxy</span>
<span class="n">group</span>       <span class="n">haproxy</span>
<span class="n">daemon</span>
<span class="n">stats</span> <span class="n">socket</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">stats</span>

<span class="n">defaults</span>
<span class="n">mode</span>    <span class="n">tcp</span>
<span class="n">log</span>     <span class="k">global</span>
<span class="n">option</span>      <span class="n">tcplog</span>
<span class="n">option</span>      <span class="n">dontlognull</span>
<span class="n">option</span>      <span class="n">http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">close</span>
<span class="c1">#option     forwardfor       except 127.0.0.0/8</span>
<span class="n">option</span>      <span class="n">redispatch</span>
<span class="n">retries</span>     <span class="mi">3</span>
<span class="n">timeout</span> <span class="n">http</span><span class="o">-</span><span class="n">request</span>    <span class="mi">10</span><span class="n">s</span>
<span class="n">timeout</span> <span class="n">queue</span>       <span class="mi">1</span><span class="n">m</span>
<span class="n">timeout</span> <span class="n">connect</span>     <span class="mi">10</span><span class="n">s</span>
<span class="n">timeout</span> <span class="n">client</span>      <span class="mi">1</span><span class="n">m</span>
<span class="n">timeout</span> <span class="n">server</span>      <span class="mi">1</span><span class="n">m</span>
<span class="n">timeout</span> <span class="n">http</span><span class="o">-</span><span class="n">keep</span><span class="o">-</span><span class="n">alive</span>     <span class="mi">10</span><span class="n">s</span>
<span class="n">timeout</span> <span class="n">check</span>       <span class="mi">10</span><span class="n">s</span>


<span class="c1">#---------------------------------------------------------------------</span>
<span class="c1"># main frontend which proxys to the backends</span>
<span class="c1">#---------------------------------------------------------------------</span>

<span class="n">listen</span> <span class="n">stats</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">8089</span>
    <span class="n">stats</span> <span class="n">enable</span>
    <span class="n">stats</span> <span class="n">uri</span> <span class="o">/</span>


<span class="n">listen</span> <span class="n">apache</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">80</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">balance</span> <span class="n">source</span>
    <span class="n">http</span><span class="o">-</span><span class="n">request</span> <span class="n">redirect</span> <span class="n">scheme</span> <span class="n">https</span> <span class="n">unless</span> <span class="p">{</span> <span class="n">ssl_fc</span> <span class="p">}</span>

<span class="n">listen</span> <span class="n">apache</span><span class="o">-</span><span class="n">ssl</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">443</span>
    <span class="c1">#use_backend socket if { dst_port 3232 }</span>
<span class="n">mode</span> <span class="n">http</span>
    <span class="n">balance</span> <span class="n">roundrobin</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">443</span> <span class="n">ssl</span> <span class="n">crt</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">wss</span><span class="o">.</span><span class="n">pem</span> <span class="n">alpn</span> <span class="n">h2</span>
    <span class="n">http</span><span class="o">-</span><span class="n">request</span> <span class="n">redirect</span> <span class="n">scheme</span> <span class="n">https</span> <span class="n">unless</span> <span class="p">{</span> <span class="n">ssl_fc</span> <span class="p">}</span>

    <span class="n">server</span>  <span class="n">app1</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.117</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">fall</span> <span class="mi">3</span> <span class="n">cookie</span> <span class="n">app1</span>
    <span class="n">server</span>  <span class="n">app2</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.118</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">fall</span> <span class="mi">3</span> <span class="n">cookie</span> <span class="n">app2</span>

<span class="n">listen</span> <span class="n">postgres</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">bind</span> <span class="o">*</span><span class="p">:</span><span class="mi">5432</span>

    <span class="n">option</span> <span class="n">httpchk</span>
    <span class="n">http</span><span class="o">-</span><span class="n">check</span> <span class="n">expect</span> <span class="n">status</span> <span class="mi">200</span>
    <span class="n">default</span><span class="o">-</span><span class="n">server</span> <span class="n">inter</span> <span class="mi">3</span><span class="n">s</span> <span class="n">fall</span> <span class="mi">3</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">on</span><span class="o">-</span><span class="n">marked</span><span class="o">-</span><span class="n">down</span> <span class="n">shutdown</span><span class="o">-</span><span class="n">sessions</span>

    <span class="n">server</span> <span class="n">pg_node1</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.123</span><span class="p">:</span><span class="mi">5432</span> <span class="n">maxconn</span> <span class="mi">1000</span> <span class="n">check</span> <span class="n">port</span> <span class="mi">8008</span> <span class="c1">#check-ssl verify none</span>
    <span class="n">server</span> <span class="n">pg_node2</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.121</span><span class="p">:</span><span class="mi">5432</span> <span class="n">maxconn</span> <span class="mi">1000</span> <span class="n">check</span> <span class="n">port</span> <span class="mi">8008</span> <span class="c1">#check-ssl verify none</span>
</pre></div>
<p>Check configuration file with below command;</p>
<div class="highlight"><pre><span></span>haproxy -c -V -f /etc/haproxy/haproxy.cfg
</pre></div>
<p>If any error correct then start haproxy service.</p>
<div class="highlight"><pre><span></span>setsebool -P haproxy_connect_any on

systemctl <span class="nb">enable</span> --now haproxy.service
</pre></div>
<p><span class="gs">Configure Keepalived</span></p>
<p>Login on <tt class="docutils literal">HAproxy_node1</tt></p>
<ul class="simple">
<li>backup defualt Keepalived.conf</li>
</ul>
<div class="highlight"><pre><span></span>cp -f /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf-orig
</pre></div>
<p>Remove everything from this file, and add the following configuration parameters.</p>
<div class="highlight"><pre><span></span><span class="n">vrrp_script</span> <span class="n">chk_haproxy</span> <span class="p">{</span>
    <span class="n">script</span> <span class="s2">&quot;killall -0 haproxy&quot;</span> <span class="c1"># check the haproxy process</span>
    <span class="n">interval</span> <span class="mi">2</span>      <span class="c1"># every 2 seconds</span>
    <span class="n">weight</span> <span class="mi">2</span>    <span class="c1"># add 2 points if OK</span>
<span class="p">}</span>
<span class="n">vrrp_instance</span> <span class="n">VI_1</span> <span class="p">{</span>
    <span class="n">interface</span> <span class="n">ens192</span>     <span class="c1"># interface to monitor</span>
    <span class="n">state</span> <span class="n">MASTER</span>     <span class="c1"># MASTER on haproxy_node1, BACKUP on haproxy_node2</span>
    <span class="n">virtual_router_id</span> <span class="mi">51</span>
    <span class="n">priority</span> <span class="mi">101</span>     <span class="c1"># 101 on haproxy_node1, 100 on haproxy_node2</span>
    <span class="n">virtual_ipaddress</span> <span class="p">{</span>
    <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.100</span><span class="o">/</span><span class="mi">24</span>     <span class="c1"># virtual ip address</span>
    <span class="p">}</span>
  <span class="n">track_script</span> <span class="p">{</span>
    <span class="n">chk_haproxy</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span>systemctl <span class="nb">enable</span> --now keepalived.service
</pre></div>
<p>Login on <tt class="docutils literal">HAproxy_node2</tt></p>
<ul class="simple">
<li>backup defualt Keepalived.conf</li>
</ul>
<div class="highlight"><pre><span></span>cp -f /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf-orig
</pre></div>
<p>Remove everything from this file, and add the following configuration parameters.</p>
<div class="highlight"><pre><span></span><span class="n">vrrp_script</span> <span class="n">chk_haproxy</span> <span class="p">{</span>
  <span class="n">script</span> <span class="s2">&quot;killall -0 haproxy&quot;</span> <span class="c1"># check the haproxy process</span>
  <span class="n">interval</span> <span class="mi">2</span>    <span class="c1"># every 2 seconds</span>
  <span class="n">weight</span> <span class="mi">2</span>      <span class="c1"># add 2 points if OK</span>
<span class="p">}</span>
<span class="n">vrrp_instance</span> <span class="n">VI_1</span> <span class="p">{</span>
  <span class="n">interface</span> <span class="n">ens192</span>       <span class="c1"># interface to monitor</span>
  <span class="n">state</span> <span class="n">BACKUP</span>       <span class="c1"># MASTER on haproxy_node1, BACKUP on haproxy_node2</span>
  <span class="n">virtual_router_id</span> <span class="mi">51</span>
  <span class="n">priority</span> <span class="mi">100</span>       <span class="c1"># 101 on haproxy_node1, 100 on haproxy_node2</span>
  <span class="n">virtual_ipaddress</span> <span class="p">{</span>
  <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.100</span><span class="o">/</span><span class="mi">24</span>       <span class="c1"># virtual ip address</span>
  <span class="p">}</span>
 <span class="n">track_script</span> <span class="p">{</span>
  <span class="n">chk_haproxy</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span>systemctl <span class="nb">enable</span> --now keepalived.service
</pre></div>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr><td><img alt="K" src="/img/keepalived.png" /></td>
</tr>
</tbody>
</table>
<p><span class="big">HAproxy Statistics Report;</span></p>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr><td><img alt="G" src="/img/hastatus.png" /></td>
</tr>
</tbody>
</table>
</div>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://govind0229.github.io/tag/awesome.html">awesome</a>
      <a href="https://govind0229.github.io/tag/thanks.html">thanks</a>
    </p>
  </div>





</article>

    <footer>
<p>&copy; 2022 Govind Kumar</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Govind Kumar ",
  "url" : "https://govind0229.github.io",
  "image": "",
  "description": ""
}
</script>

</body>
</html>